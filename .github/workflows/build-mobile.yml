name: Build Android & iOS

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: Build Android (APK/AAB)
        type: boolean
        default: true
      build_ios:
        description: Build iOS (IPA)
        type: boolean
        default: true

jobs:
  android:
    if: ${{ inputs.build_android }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Flutter pub get
        run: flutter pub get

      - name: Build APK (release)
        run: flutter build apk --release

      - name: Build App Bundle (AAB)
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

  ios:
    if: ${{ inputs.build_ios }}
    runs-on: macos-latest
    env:
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Flutter pub get
        run: flutter pub get

      # Podfile sudah di-repo; tidak perlu generate otomatis

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods --no-document || true
          pod repo update
          pod install --repo-update --verbose
        working-directory: ios

      - name: Import signing certificates & provisioning profile
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_CERT_P12_PASSWORD }}

      - name: Install provisioning profile (base64)
        if: ${{ env.IOS_PROFILE_BASE64 != '' }}
        run: |
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          echo "$IOS_PROFILE_BASE64" | base64 -D > "$PROFILE_DIR/ci.mobileprovision"
          ls "$PROFILE_DIR"

      # pub get already executed above before installing pods

      - name: Optionally override bundle identifier
        if: ${{ env.IOS_BUNDLE_ID != '' }}
        run: sed -i '' -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]*;/PRODUCT_BUNDLE_IDENTIFIER = ${{ env.IOS_BUNDLE_ID }};/g" ios/Runner.xcodeproj/project.pbxproj

      - name: Optionally set development team for Release
        if: ${{ env.IOS_TEAM_ID != '' }}
        run: echo "DEVELOPMENT_TEAM=${{ env.IOS_TEAM_ID }}" >> ios/Flutter/Release.xcconfig

      - name: Build IPA (release)
        env:
          DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
        run: |
          flutter build ipa --release

      - name: Upload iOS artifact (IPA)
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/ipa/Runner.ipa
